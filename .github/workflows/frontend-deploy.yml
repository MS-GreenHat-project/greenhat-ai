name: Deploy Frontend to Azure Storage and CDN

on:
  push:
    branches:
      - hjh  # í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë¸Œëœì¹˜
    paths:
      - 'index.html'  # index.html íŒŒì¼ ë³€ê²½ ì‹œì—ë§Œ íŠ¸ë¦¬ê±°
      - 'assets/**'   # assets í´ë” ë³€ê²½ ì‹œì—ë„ íŠ¸ë¦¬ê±° (í•„ìš”ì‹œ)
      - 'css/**'      # CSS íŒŒì¼ ë³€ê²½ ì‹œì—ë„ íŠ¸ë¦¬ê±° (í•„ìš”ì‹œ)
      - 'js/**'       # JS íŒŒì¼ ë³€ê²½ ì‹œì—ë„ íŠ¸ë¦¬ê±° (í•„ìš”ì‹œ)

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    env:
      STORAGE_ACCOUNT: greenhat111
      CONTAINER_NAME: '$web'
      CDN_PROFILE: greenhat-profile
      CDN_ENDPOINT: greenhat
      RESOURCE_GROUP: Green-Hat

    steps:
      # 1. GitHub Repo Checkout
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # 2. Azure CLI ë¡œê·¸ì¸
      - name: 'Login to Azure'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. ì •ì  íŒŒì¼ë“¤ì„ Azure Storageì— ì—…ë¡œë“œ
      - name: 'Upload files to Azure Storage'
        run: |
          echo "ğŸ“ Uploading files to Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          
          # index.html ì—…ë¡œë“œ
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --container-name '${{ env.CONTAINER_NAME }}' \
            --name index.html \
            --file index.html \
            --content-type "text/html" \
            --overwrite
          
          echo "âœ… index.html uploaded successfully"
          
          # ì¶”ê°€ ì •ì  íŒŒì¼ë“¤ì´ ìˆë‹¤ë©´ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)
          if [ -d "assets" ]; then
            echo "ğŸ“ Uploading assets folder..."
            az storage blob upload-batch \
              --account-name ${{ env.STORAGE_ACCOUNT }} \
              --destination '${{ env.CONTAINER_NAME }}' \
              --source assets \
              --destination-path assets \
              --overwrite
          fi
          
          if [ -d "css" ]; then
            echo "ğŸ“ Uploading CSS files..."
            az storage blob upload-batch \
              --account-name ${{ env.STORAGE_ACCOUNT }} \
              --destination '${{ env.CONTAINER_NAME }}' \
              --source css \
              --destination-path css \
              --overwrite
          fi
          
          if [ -d "js" ]; then
            echo "ğŸ“ Uploading JS files..."
            az storage blob upload-batch \
              --account-name ${{ env.STORAGE_ACCOUNT }} \
              --destination '${{ env.CONTAINER_NAME }}' \
              --source js \
              --destination-path js \
              --overwrite
          fi

      # 4. Azure Front Door CDN ìºì‹œ í¼ì§€
      - name: 'Purge CDN Cache'
        run: |
          echo "ğŸ”„ Purging CDN cache for Front Door endpoint..."
          az afd endpoint purge \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --profile-name ${{ env.CDN_PROFILE }} \
            --endpoint-name ${{ env.CDN_ENDPOINT }} \
            --content-paths "/*"
          
          echo "âœ… CDN cache purged successfully"

      # 5. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: 'Deployment Summary'
        run: |
          echo "ğŸš€ Frontend deployment completed!"
          echo "ğŸ“ Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          echo "ğŸŒ CDN Endpoint: https://greenhat-bzcacegbe8gtdrd0.a02.azurefd.net"
          echo "ğŸ“ Files updated: index.html"
          echo "ğŸ”„ CDN cache has been purged"
          echo "â° Deployment time: $(date)"
