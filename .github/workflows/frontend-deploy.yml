name: Deploy Frontend to Azure Storage

on:
  push:
    branches:
      - main
      - hjh  # 현재 사용 중인 브랜치
    paths:
      - 'index.html'  # index.html 파일 변경 시에만 트리거
      - 'assets/**'   # assets 폴더 변경 시에도 트리거 (필요시)
      - 'css/**'      # CSS 파일 변경 시에도 트리거 (필요시)
      - 'js/**'       # JS 파일 변경 시에도 트리거 (필요시)

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    env:
      STORAGE_ACCOUNT: greenhat111
      CONTAINER_NAME: '$web'

    steps:
      # 1. GitHub Repo Checkout
      - name: 'Checkout Repository'
        uses: actions/checkout@v4

      # 2. 파일 변경 확인
      - name: 'Check changed files'
        run: |
          echo "📁 Preparing to upload files to Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          echo "📝 Changed files will be uploaded to Blob Storage"
          ls -la index.html

      # 3. Azure Storage에 파일 업로드
      - name: 'Upload files to Azure Storage'
        run: |
          echo "📁 Uploading index.html to Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          
          # Storage Account Key가 설정되어 있는지 확인
          if [ -z "${{ secrets.AZURE_STORAGE_KEY }}" ]; then
            echo "❌ AZURE_STORAGE_KEY secret is not set"
            echo "💡 Please add AZURE_STORAGE_KEY to GitHub repository secrets"
            exit 1
          fi
          
          # index.html 업로드
          az storage blob upload \
            --account-name ${{ env.STORAGE_ACCOUNT }} \
            --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
            --container-name '${{ env.CONTAINER_NAME }}' \
            --name index.html \
            --file index.html \
            --content-type "text/html" \
            --overwrite
          
          echo "✅ index.html uploaded successfully"

      # 4. 배포 완료 알림
      - name: 'Deployment Summary'
        run: |
          echo "🚀 Frontend deployment completed!"
          echo "📍 Storage Account: ${{ env.STORAGE_ACCOUNT }}"
          echo "🌐 CDN Endpoint: https://greenhat-bzcacegbe8gtdrd0.a02.azurefd.net"
          echo "📝 Files updated: index.html"
          echo "⏰ Deployment time: $(date)"
          echo "💡 CDN cache may take a few minutes to refresh"
