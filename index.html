<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>실시간 헬멧 감지</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        #container { 
            position: relative; 
            display: inline-block;
            border: 3px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        #video, #canvas { 
            width: 640px; 
            height: 480px; 
            display: block;
        }
        
        #canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        
        /* 경고등 스타일 */
        #warning-panel {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        #warning-panel.safe {
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }
        
        #warning-panel.warning {
            background-color: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
            animation: pulse 1s infinite;
        }
        
        #warning-panel.danger {
            background-color: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            animation: flashRed 0.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @keyframes flashRed {
            0% { background-color: #f8d7da; }
            50% { background-color: #dc3545; color: white; }
            100% { background-color: #f8d7da; }
        }
        
        .warning-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .warning-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .warning-detail {
            font-size: 16px;
            opacity: 0.8;
        }
        
        /* 상태 인디케이터 */
        #status-indicators {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .status-indicator {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .helmet-detected {
            background-color: #28a745;
            color: white;
        }
        
        .head-detected {
            background-color: #ffc107;
            color: #212529;
        }
        
        .no-detection {
            background-color: #6c757d;
            color: white;
        }
        
        /* 연결 상태 표시 */
        #connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        #connection-status.connected {
            background-color: #28a745;
            color: white;
        }
        
        #connection-status.disconnected {
            background-color: #dc3545;
            color: white;
        }
        
        /* 통계 패널 */
        #stats-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            border: 1px solid #ddd;
            display: inline-block;
        }
        
        .stat-item {
            display: inline-block;
            margin: 0 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <h2>🚧 실시간 헬멧 감지 시스템</h2>
    
    <div id="connection-status" class="disconnected">연결 중...</div>
    
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <!-- 경고등 패널 -->
    <div id="warning-panel" class="safe">
        <div class="warning-icon">⚠️</div>
        <div class="warning-text">시스템 대기 중</div>
        <div class="warning-detail">카메라 연결을 확인하세요</div>
    </div>

    <!-- 상태 인디케이터 -->
    <div id="status-indicators">
        <div id="helmet-count" class="status-indicator no-detection">헬멧: 0명</div>
        <div id="head-count" class="status-indicator no-detection">미착용: 0명</div>
    </div>

    <!-- 통계 패널 -->
    <div id="stats-panel">
        <div class="stat-item">
            <div id="total-detections" class="stat-number">0</div>
            <div class="stat-label">총 감지</div>
        </div>
        <div class="stat-item">
            <div id="helmet-rate" class="stat-number">0%</div>
            <div class="stat-label">착용률</div>
        </div>
        <div class="stat-item">
            <div id="last-update" class="stat-number">--:--</div>
            <div class="stat-label">마지막 업데이트</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        const socket = io.connect('http://127.0.0.1:5000');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const classNames = ['head', 'helmet'];
        
        // UI 요소들
        const warningPanel = document.getElementById('warning-panel');
        const connectionStatus = document.getElementById('connection-status');
        const helmetCount = document.getElementById('helmet-count');
        const headCount = document.getElementById('head-count');
        const totalDetections = document.getElementById('total-detections');
        const helmetRate = document.getElementById('helmet-rate');
        const lastUpdate = document.getElementById('last-update');
        
        // 통계 변수
        let stats = {
            totalDetections: 0,
            helmetDetections: 0,
            headDetections: 0
        };

        // 카메라 시작
        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            video.srcObject = stream;
            updateWarningPanel('safe', '📹', '카메라 연결됨', '서버 연결을 기다리는 중...');
        }).catch(err => {
            console.error('카메라 오류:', err);
            updateWarningPanel('danger', '❌', '카메라 오류', '카메라 접근을 허용해주세요');
        });

        // 소켓 연결
        socket.on('connect', () => {
            console.log('✅ 연결됨');
            connectionStatus.textContent = '연결됨';
            connectionStatus.className = 'connected';
            updateWarningPanel('safe', '✅', '시스템 준비됨', '헬멧 감지를 시작합니다');
            
            // 프레임 전송 시작
            setInterval(() => {
                if (video.videoWidth === 0) return;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const dataURL = canvas.toDataURL('image/jpeg');
                socket.emit('analyze_frame', dataURL);
            }, 300);
        });

        // 분석 결과 처리
        socket.on('analysis_result', data => {
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            let currentHelmetCount = 0;
            let currentHeadCount = 0;
            
            // 바운딩 박스 그리기
            data.boxes.forEach((box, i) => {
                const [x1, y1, x2, y2] = box;
                const cls = data.classes[i];
                const conf = data.conf[i];

                const x = x1 * canvas.width;
                const y = y1 * canvas.height;
                const w = (x2 - x1) * canvas.width;
                const h = (y2 - y1) * canvas.height;

                const color = classNames[cls] === 'helmet' ? 'lime' : 'red';
                const label = `${classNames[cls]} ${conf.toFixed(2)}`;

                context.strokeStyle = color;
                context.lineWidth = 3;
                context.strokeRect(x, y, w, h);
                context.font = '16px Arial';
                context.fillStyle = color;
                context.fillText(label, x, y > 20 ? y - 5 : y + h + 15);
                
                // 카운트 업데이트
                if (classNames[cls] === 'helmet') {
                    currentHelmetCount++;
                    stats.helmetDetections++;
                } else {
                    currentHeadCount++;
                    stats.headDetections++;
                }
                stats.totalDetections++;
            });
            
            // UI 업데이트
            updateCounts(currentHelmetCount, currentHeadCount);
            updateWarningStatus(currentHelmetCount, currentHeadCount);
            updateStats();
            updateLastUpdate();
        });

        // 연결 해제
        socket.on('disconnect', () => {
            console.log('❌ 연결 종료');
            connectionStatus.textContent = '연결 끊김';
            connectionStatus.className = 'disconnected';
            updateWarningPanel('danger', '❌', '연결 끊김', '서버와의 연결이 끊어졌습니다');
        });

        // 경고 패널 업데이트
        function updateWarningPanel(type, icon, text, detail) {
            warningPanel.className = type;
            warningPanel.querySelector('.warning-icon').textContent = icon;
            warningPanel.querySelector('.warning-text').textContent = text;
            warningPanel.querySelector('.warning-detail').textContent = detail;
        }

        // 경고 상태 업데이트
        function updateWarningStatus(helmetCount, headCount) {
            if (headCount > 0) {
                // 헬멧 미착용자가 있을 때
                updateWarningPanel('danger', '🚨', '헬멧 미착용 감지!', `${headCount}명이 헬멧을 착용하지 않았습니다`);
            } else if (helmetCount > 0) {
                // 모든 사람이 헬멧을 착용했을 때
                updateWarningPanel('safe', '✅', '안전 상태', `${helmetCount}명이 헬멧을 착용했습니다`);
            } else {
                // 아무도 감지되지 않았을 때
                updateWarningPanel('warning', '👁️', '감지 대기 중', '작업자를 찾고 있습니다');
            }
        }

        // 카운트 업데이트
        function updateCounts(helmetCount, headCount) {
            helmetCount.textContent = `헬멧: ${helmetCount}명`;
            headCount.textContent = `미착용: ${headCount}명`;
            
            // 스타일 업데이트
            helmetCount.className = `status-indicator ${helmetCount > 0 ? 'helmet-detected' : 'no-detection'}`;
            headCount.className = `status-indicator ${headCount > 0 ? 'head-detected' : 'no-detection'}`;
        }

        // 통계 업데이트
        function updateStats() {
            totalDetections.textContent = stats.totalDetections;
            
            const rate = stats.totalDetections > 0 ? 
                Math.round((stats.helmetDetections / stats.totalDetections) * 100) : 0;
            helmetRate.textContent = `${rate}%`;
        }

        // 마지막 업데이트 시간
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            lastUpdate.textContent = timeString;
        }
    </script>
</body>
</html>