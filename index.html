<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ í—¬ë©§ ê°ì§€</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            text-align: center; 
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        
        #container { 
            position: relative; 
            display: inline-block;
            border: 3px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        #video, #canvas { 
            width: 640px; 
            height: 480px; 
            display: block;
        }
        
        #canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
        }
        
        /* ê²½ê³ ë“± ìŠ¤íƒ€ì¼ */
        #warning-panel {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        #warning-panel.safe {
            background-color: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
        }
        
        #warning-panel.warning {
            background-color: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
            animation: pulse 1s infinite;
        }
        
        #warning-panel.danger {
            background-color: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            animation: flashRed 0.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        @keyframes flashRed {
            0% { background-color: #f8d7da; }
            50% { background-color: #dc3545; color: white; }
            100% { background-color: #f8d7da; }
        }
        
        .warning-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .warning-text {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .warning-detail {
            font-size: 16px;
            opacity: 0.8;
        }
        
        /* ìƒíƒœ ì¸ë””ì¼€ì´í„° */
        #status-indicators {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .status-indicator {
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .helmet-detected {
            background-color: #28a745;
            color: white;
        }
        
        .head-detected {
            background-color: #ffc107;
            color: #212529;
        }
        
        .no-detection {
            background-color: #6c757d;
            color: white;
        }
        
        /* ì—°ê²° ìƒíƒœ í‘œì‹œ */
        #connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        #connection-status.connected {
            background-color: #28a745;
            color: white;
        }
        
        #connection-status.disconnected {
            background-color: #dc3545;
            color: white;
        }
        
        /* í†µê³„ íŒ¨ë„ */
        #stats-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 10px;
            border: 1px solid #ddd;
            display: inline-block;
        }
        
        .stat-item {
            display: inline-block;
            margin: 0 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <h2>ğŸš§ ì‹¤ì‹œê°„ í—¬ë©§ ê°ì§€ ì‹œìŠ¤í…œ</h2>
    
    <div id="connection-status" class="disconnected">ì—°ê²° ì¤‘...</div>
    
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <!-- ê²½ê³ ë“± íŒ¨ë„ -->
    <div id="warning-panel" class="safe">
        <div class="warning-icon">âš ï¸</div>
        <div class="warning-text">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘</div>
        <div class="warning-detail">ì¹´ë©”ë¼ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”</div>
    </div>

    <!-- ìƒíƒœ ì¸ë””ì¼€ì´í„° -->
    <div id="status-indicators">
        <div id="helmet-count" class="status-indicator no-detection">í—¬ë©§: 0ëª…</div>
        <div id="head-count" class="status-indicator no-detection">ë¯¸ì°©ìš©: 0ëª…</div>
    </div>

    <!-- í†µê³„ íŒ¨ë„ -->
    <div id="stats-panel">
        <div class="stat-item">
            <div id="total-detections" class="stat-number">0</div>
            <div class="stat-label">ì´ ê°ì§€</div>
        </div>
        <div class="stat-item">
            <div id="helmet-rate" class="stat-number">0%</div>
            <div class="stat-label">ì°©ìš©ë¥ </div>
        </div>
        <div class="stat-item">
            <div id="last-update" class="stat-number">--:--</div>
            <div class="stat-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script>
        const socket = io.connect('http://127.0.0.1:5000');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const classNames = ['head', 'helmet'];
        
        // UI ìš”ì†Œë“¤
        const warningPanel = document.getElementById('warning-panel');
        const connectionStatus = document.getElementById('connection-status');
        const helmetCount = document.getElementById('helmet-count');
        const headCount = document.getElementById('head-count');
        const totalDetections = document.getElementById('total-detections');
        const helmetRate = document.getElementById('helmet-rate');
        const lastUpdate = document.getElementById('last-update');
        
        // í†µê³„ ë³€ìˆ˜
        let stats = {
            totalDetections: 0,
            helmetDetections: 0,
            headDetections: 0
        };

        // ì¹´ë©”ë¼ ì‹œì‘
        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            video.srcObject = stream;
            updateWarningPanel('safe', 'ğŸ“¹', 'ì¹´ë©”ë¼ ì—°ê²°ë¨', 'ì„œë²„ ì—°ê²°ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...');
        }).catch(err => {
            console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', err);
            updateWarningPanel('danger', 'âŒ', 'ì¹´ë©”ë¼ ì˜¤ë¥˜', 'ì¹´ë©”ë¼ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”');
        });

        // ì†Œì¼“ ì—°ê²°
        socket.on('connect', () => {
            console.log('âœ… ì—°ê²°ë¨');
            connectionStatus.textContent = 'ì—°ê²°ë¨';
            connectionStatus.className = 'connected';
            updateWarningPanel('safe', 'âœ…', 'ì‹œìŠ¤í…œ ì¤€ë¹„ë¨', 'í—¬ë©§ ê°ì§€ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤');
            
            // í”„ë ˆì„ ì „ì†¡ ì‹œì‘
            setInterval(() => {
                if (video.videoWidth === 0) return;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const dataURL = canvas.toDataURL('image/jpeg');
                socket.emit('analyze_frame', dataURL);
            }, 300);
        });

        // ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬
        socket.on('analysis_result', data => {
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            let currentHelmetCount = 0;
            let currentHeadCount = 0;
            
            // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
            data.boxes.forEach((box, i) => {
                const [x1, y1, x2, y2] = box;
                const cls = data.classes[i];
                const conf = data.conf[i];

                const x = x1 * canvas.width;
                const y = y1 * canvas.height;
                const w = (x2 - x1) * canvas.width;
                const h = (y2 - y1) * canvas.height;

                const color = classNames[cls] === 'helmet' ? 'lime' : 'red';
                const label = `${classNames[cls]} ${conf.toFixed(2)}`;

                context.strokeStyle = color;
                context.lineWidth = 3;
                context.strokeRect(x, y, w, h);
                context.font = '16px Arial';
                context.fillStyle = color;
                context.fillText(label, x, y > 20 ? y - 5 : y + h + 15);
                
                // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                if (classNames[cls] === 'helmet') {
                    currentHelmetCount++;
                    stats.helmetDetections++;
                } else {
                    currentHeadCount++;
                    stats.headDetections++;
                }
                stats.totalDetections++;
            });
            
            // UI ì—…ë°ì´íŠ¸
            updateCounts(currentHelmetCount, currentHeadCount);
            updateWarningStatus(currentHelmetCount, currentHeadCount);
            updateStats();
            updateLastUpdate();
        });

        // ì—°ê²° í•´ì œ
        socket.on('disconnect', () => {
            console.log('âŒ ì—°ê²° ì¢…ë£Œ');
            connectionStatus.textContent = 'ì—°ê²° ëŠê¹€';
            connectionStatus.className = 'disconnected';
            updateWarningPanel('danger', 'âŒ', 'ì—°ê²° ëŠê¹€', 'ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
        });

        // ê²½ê³  íŒ¨ë„ ì—…ë°ì´íŠ¸
        function updateWarningPanel(type, icon, text, detail) {
            warningPanel.className = type;
            warningPanel.querySelector('.warning-icon').textContent = icon;
            warningPanel.querySelector('.warning-text').textContent = text;
            warningPanel.querySelector('.warning-detail').textContent = detail;
        }

        // ê²½ê³  ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateWarningStatus(helmetCount, headCount) {
            if (headCount > 0) {
                // í—¬ë©§ ë¯¸ì°©ìš©ìê°€ ìˆì„ ë•Œ
                updateWarningPanel('danger', 'ğŸš¨', 'í—¬ë©§ ë¯¸ì°©ìš© ê°ì§€!', `${headCount}ëª…ì´ í—¬ë©§ì„ ì°©ìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤`);
            } else if (helmetCount > 0) {
                // ëª¨ë“  ì‚¬ëŒì´ í—¬ë©§ì„ ì°©ìš©í–ˆì„ ë•Œ
                updateWarningPanel('safe', 'âœ…', 'ì•ˆì „ ìƒíƒœ', `${helmetCount}ëª…ì´ í—¬ë©§ì„ ì°©ìš©í–ˆìŠµë‹ˆë‹¤`);
            } else {
                // ì•„ë¬´ë„ ê°ì§€ë˜ì§€ ì•Šì•˜ì„ ë•Œ
                updateWarningPanel('warning', 'ğŸ‘ï¸', 'ê°ì§€ ëŒ€ê¸° ì¤‘', 'ì‘ì—…ìë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤');
            }
        }

        // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateCounts(helmetCount, headCount) {
            helmetCount.textContent = `í—¬ë©§: ${helmetCount}ëª…`;
            headCount.textContent = `ë¯¸ì°©ìš©: ${headCount}ëª…`;
            
            // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            helmetCount.className = `status-indicator ${helmetCount > 0 ? 'helmet-detected' : 'no-detection'}`;
            headCount.className = `status-indicator ${headCount > 0 ? 'head-detected' : 'no-detection'}`;
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            totalDetections.textContent = stats.totalDetections;
            
            const rate = stats.totalDetections > 0 ? 
                Math.round((stats.helmetDetections / stats.totalDetections) * 100) : 0;
            helmetRate.textContent = `${rate}%`;
        }

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
            lastUpdate.textContent = timeString;
        }
    </script>
</body>
</html>